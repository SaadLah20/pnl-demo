generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// =======================
// TYPES (ex-enums) -> String
// =======================
//
// Champs concernés :
// - Pnl.model            (ex: CAB_FIXE_EXISTANT, CAB_FIXE_NOUVELLE, CAB_MOBILE_CLIENT)
// - Pnl.status           (ex: ENCOURS, PERDU, ADJUGE)
// - Variant.status       (ex: INITIALISEE, ENCOURS, ANNULEE, CLOTUREE)
// - Section*.category    (ex: LOGISTIQUE_APPRO, FORMULES, COUTS_CHARGES, DEVIS)
// - Contract.*           (ex: LHM, CLIENT, EXISTANTE, PARTAGE, PRESTATAIRE)
// - SectionCab.etat      (ex: NEUVE, DEGRADEE)
// - SectionCab.mode      (ex: ACHAT, LOCATION, PROPRE)
// - SectionAutresCouts.unite (ex: M3, MOIS, FORFAIT, POURCENT_CA)

// =======================
// CORE
// =======================

model Pnl {
  id        String    @id @default(uuid())
  title     String
  model     String // ex: CAB_FIXE_EXISTANT | CAB_FIXE_NOUVELLE | CAB_MOBILE_CLIENT
  client    String?
  status    String    @default("ENCOURS") // ex: ENCOURS | PERDU | ADJUGE
  startDate DateTime?
  city      String
  region    String
  createdAt DateTime  @default(now())

  contracts Contract[]
}

model Contract {
  id              String @id @default(uuid())
  pnlId           String
  pnl             Pnl    @relation(fields: [pnlId], references: [id])
  dureeMois       Int    @default(0)
  cab             String // ex: LHM | CLIENT | EXISTANTE | PARTAGE | PRESTATAIRE
  installation    String
  genieCivil      String
  transport       String
  terrain         String
  matierePremiere String
  maintenance     String
  chargeuse       String
  branchementEau  String
  consoEau        String
  branchementElec String
  consoElec       String

  postes       Int
  sundayPrice  Float
  delayPenalty Float
  chillerRent  Float

  variants Variant[]
}

model Variant {
  id          String  @id @default(uuid())
  title       String
  description String?
  status      String  @default("INITIALISEE") // ex: INITIALISEE | ENCOURS | ANNULEE | CLOTUREE

  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  // Sections (1:1 optionnelles)
  mp              SectionMatierePremiere?
  transport       SectionTransport?
  cab             SectionCab?
  maintenance     SectionMaintenance?
  coutM3          SectionCoutM3?
  coutMensuel     SectionCoutMensuel?
  coutOccasionnel SectionCoutOccasionnel?
  employes        SectionEmployes?
  autresCouts     SectionAutresCouts?
  formules        SectionFormules?
  majorations     SectionMajorations?
  devis           SectionDevis?

  // Liaisons "listes"
  variantMps      VariantMp[]
  variantFormules VariantFormule[]

  autreCoutItems AutreCoutItem[]
}

// =======================
// SECTIONS
// =======================

model SectionMatierePremiere {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items VariantMp[]
}

model SectionTransport {
  id        String @id @default(uuid())
  variantId String @unique
  category  String // ex: LOGISTIQUE_APPRO | ...
  type      String
  prixMoyen Float?

  volumePompePct Float? // % pompé (0..100)
  prixAchatPompe Float?
  prixVentePompe Float?

  variant Variant @relation(fields: [variantId], references: [id])
}

model SectionCab {
  id         String  @id @default(uuid())
  variantId  String  @unique
  category   String // ex: LOGISTIQUE_APPRO | ...
  etat       String // ex: NEUVE | DEGRADEE
  mode       String // ex: ACHAT | LOCATION | PROPRE
  capaciteM3 Float
  amortMois  Float
  variant    Variant @relation(fields: [variantId], references: [id])
}

model SectionMaintenance {
  id         String  @id @default(uuid())
  variantId  String  @unique
  category   String // ex: COUTS_CHARGES | ...
  cab        Float
  elec       Float
  chargeur   Float
  generale   Float
  bassins    Float
  preventive Float
  variant    Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutM3 {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  eau       Float
  qualite   Float
  dechets   Float
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutMensuel {
  id          String  @id @default(uuid())
  variantId   String  @unique
  category    String
  electricite Float
  gasoil      Float
  location    Float
  securite    Float
  variant     Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutOccasionnel {
  id           String  @id @default(uuid())
  variantId    String  @unique
  category     String
  genieCivil   Float
  installation Float
  transport    Float
  variant      Variant @relation(fields: [variantId], references: [id])
}

model SectionEmployes {
  id               String  @id @default(uuid())
  variantId        String  @unique
  category         String
  responsableNb    Float
  responsableCout  Float
  centralistesNb   Float
  centralistesCout Float
  variant          Variant @relation(fields: [variantId], references: [id])
}

model SectionAutresCouts {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items AutreCoutItem[]
}

model AutreCoutItem {
  id String @id @default(uuid())

  sectionId String
  section   SectionAutresCouts @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  variantId String
  variant   Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  label  String
  unite  String // M3 | MOIS | FORFAIT | POURCENT_CA
  valeur Float

  @@index([variantId])
  @@index([sectionId])
}

model SectionFormules {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items VariantFormule[]
}

model SectionMajorations {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionDevis {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  surcharge Float   @default(0)
  variant   Variant @relation(fields: [variantId], references: [id])
}

// =======================
// REPERTOIRES GLOBAUX
// =======================

model MpCatalogue {
  id          String  @id @default(uuid())
  categorie   String
  label       String
  unite       String
  prix        Float
  fournisseur String
  city        String
  region      String
  comment     String?

  formuleItems FormuleCatalogueItem[]
  variantItems VariantMp[]
}

model FormuleCatalogue {
  id         String  @id @default(uuid())
  label      String
  resistance String
  city       String
  region     String
  comment    String?

  items        FormuleCatalogueItem[]
  variantItems VariantFormule[]
}

model FormuleCatalogueItem {
  id        String @id @default(uuid())
  formuleId String
  mpId      String
  qty       Float

  formule FormuleCatalogue @relation(fields: [formuleId], references: [id])
  mp      MpCatalogue      @relation(fields: [mpId], references: [id])

  @@unique([formuleId, mpId])
}

model VariantMp {
  id        String  @id @default(uuid())
  variantId String
  sectionId String?
  mpId      String
  prix      Float
  comment   String?

  variant Variant                 @relation(fields: [variantId], references: [id])
  section SectionMatierePremiere? @relation(fields: [sectionId], references: [id])
  mp      MpCatalogue             @relation(fields: [mpId], references: [id])

  @@unique([variantId, mpId])
}

model VariantFormule {
  id        String  @id @default(uuid())
  variantId String
  sectionId String?
  formuleId String
  volumeM3  Float
  momd      Float

  variant Variant          @relation(fields: [variantId], references: [id])
  section SectionFormules? @relation(fields: [sectionId], references: [id])
  formule FormuleCatalogue @relation(fields: [formuleId], references: [id])

  @@unique([variantId, formuleId])
}
