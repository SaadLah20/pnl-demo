generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// =======================
// CORE
// =======================

model Pnl {
  id        String    @id @default(uuid())
  title     String
  model     String
  client    String?
  status    String    @default("ENCOURS")
  startDate DateTime?
  city      String
region String @default("")
  createdAt DateTime  @default(now())

  contracts Contract[]
}

model Contract {
  id              String @id @default(uuid())
  pnlId           String
  pnl             Pnl    @relation(fields: [pnlId], references: [id])
  dureeMois       Int    @default(0)
  cab             String
  installation    String
  genieCivil      String
  transport       String
  terrain         String
  matierePremiere String
  maintenance     String
  chargeuse       String

  branchementEau String?
  consoEau       String?
  branchementElec String?
  consoElec      String?

  postes      Int?
  sundayPrice Float?
  delayPenalty Float?
  chillerRent Float?

  variants Variant[]
}

// =======================
// VARIANT
// =======================

model Variant {
  id          String  @id @default(uuid())
  title       String
  description String?
  status      String  @default("INITIALISEE")

  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  mp              SectionMatierePremiere?
  transport       SectionTransport?
  cab             SectionCab?
  maintenance     SectionMaintenance?
  coutM3          SectionCoutM3?
  coutMensuel     SectionCoutMensuel?
  coutOccasionnel SectionCoutOccasionnel?
  employes        SectionEmployes?
  autresCouts     SectionAutresCouts?
  formules        SectionFormules?
  majorations     SectionMajorations?
  devis           SectionDevis?

  variantMps      VariantMp[]
  variantFormules VariantFormule[]

  autreCoutItems AutreCoutItem[]
}

// =======================
// SECTIONS
// =======================

model SectionMatierePremiere {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items VariantMp[]
}

model VariantMp {
  id        String @id @default(uuid())
  variantId String
  sectionId String
  mpId      String
  prix      Float?
  comment   String?

  variant  Variant               @relation(fields: [variantId], references: [id])
  section  SectionMatierePremiere @relation(fields: [sectionId], references: [id])
  mp       MpCatalogue           @relation(fields: [mpId], references: [id])
}

model SectionTransport {
  id              String  @id @default(uuid())
  variantId        String  @unique
  category         String
  type             String
  prixMoyen         Float   @default(0)
  volumePompePct    Float?
  prixAchatPompe    Float?
  prixVentePompe    Float?
  variant          Variant @relation(fields: [variantId], references: [id])
}

model SectionCab {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  etat      String
  mode      String
  capaciteM3 Float  @default(0)
  amortMois Int     @default(0)
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionMaintenance {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  cab       Float   @default(0)
  elec      Float   @default(0)
  chargeur  Float   @default(0)
  generale  Float   @default(0)
  bassins   Float   @default(0)
  preventive Float  @default(0)
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutM3 {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  eau       Float   @default(0)
  qualite   Float   @default(0)
  dechets   Float   @default(0)
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutMensuel {
  id                 String  @id @default(uuid())
  variantId           String  @unique
  category            String
  electricite         Float   @default(0)
  gasoil              Float   @default(0)
  location            Float   @default(0)
  securite            Float   @default(0)
  hebergements        Float   @default(0)
  locationTerrain     Float   @default(0)
  telephone           Float   @default(0)
  troisG              Float   @default(0)
  taxeProfessionnelle Float   @default(0)
  locationVehicule    Float   @default(0)
  locationAmbulance   Float   @default(0)
  locationBungalows   Float   @default(0)
  epi                 Float   @default(0)
  variant             Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutOccasionnel {
  id                 String  @id @default(uuid())
  variantId           String  @unique
  category            String
  genieCivil          Float   @default(0)
  installation        Float   @default(0)
  transport           Float   @default(0)
  demontage           Float   @default(0)
  remisePointCentrale Float   @default(0)
  silots              Float   @default(0)
  localAdjuvant       Float   @default(0)
  bungalows           Float   @default(0)
  variant             Variant @relation(fields: [variantId], references: [id])
}

model SectionEmployes {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  // ✅ Champs employés
  responsableNb                  Int   @default(0)
  responsableCout                Float @default(0)

  centralistesNb                 Int   @default(0)
  centralistesCout               Float @default(0)

  manoeuvreNb                    Int   @default(0)
  manoeuvreCout                  Float @default(0)

  coordinateurExploitationNb     Int   @default(0)
  coordinateurExploitationCout   Float @default(0)

  technicienLaboNb               Int   @default(0)
  technicienLaboCout             Float @default(0)

  femmeMenageNb                  Int   @default(0)
  femmeMenageCout                Float @default(0)

  gardienNb                      Int   @default(0)
  gardienCout                    Float @default(0)

  maintenancierNb                Int   @default(0)
  maintenancierCout              Float @default(0)

  panierRepasNb                  Int   @default(0)
  panierRepasCout                Float @default(0)
}


model SectionAutresCouts {
  id          String  @id @default(uuid())
  variantId   String  @unique
  category    String
  majorations String  @default("{}") // <-- AJOUT
  variant     Variant @relation(fields: [variantId], references: [id])

  items AutreCoutItem[]
}

model AutreCoutItem {
  id        String @id @default(uuid())
  variantId String
  sectionId String
  label     String
  unite     String
  valeur    Float

  variant Variant          @relation(fields: [variantId], references: [id])
  section SectionAutresCouts @relation(fields: [sectionId], references: [id])
}

model SectionFormules {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items VariantFormule[]
}

model VariantFormule {
  id         String  @id @default(uuid())
  variantId  String
  sectionId  String
  formuleId  String
  volumeM3   Float   @default(0)
  momd       Float   @default(0)
  cmpOverride Float?

  variant Variant         @relation(fields: [variantId], references: [id])
  section SectionFormules @relation(fields: [sectionId], references: [id])
  formule FormuleCatalogue @relation(fields: [formuleId], references: [id])
}

model SectionMajorations {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionDevis {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String

  // legacy/global surcharge (kept for backward compatibility)
  surcharge Float   @default(0)

  // ✅ devis content (JSON strings) — allows later Word/PDF export
  meta               String @default("{}")  // { date, titreProjet, client, ... }
  intro              String @default("")    // free text
  rappel              String @default("{}") // { dureeMois, quantiteM3, ... }
  chargeFournisseur  String @default("[]")  // DevisLineItem[]
  chargeClient       String @default("[]")  // DevisLineItem[]
  prixComplementaires String @default("[]") // DevisLineItem[]
  validiteTexte      String @default("")    // free text (validité)
  signature          String @default("{}")  // { nom, poste, telephone }

  // ✅ surcharges par formule (map JSON: { [variantFormuleId]: number })
  surcharges         String @default("{}")

  variant   Variant @relation(fields: [variantId], references: [id])
}

// =======================
// CATALOGUES
// =======================

model MpCatalogue {
  id          String  @id @default(uuid())
  categorie   String
  label       String
  unite       String
  prix        Float   @default(0)
  fournisseur String?
  city        String?
  region      String?
  comment     String?

  formuleItems FormuleCatalogueItem[]
  variantMps   VariantMp[]
}

model FormuleCatalogue {
  id         String  @id @default(uuid())
  label      String
  resistance String
  city       String
  region     String
  comment    String?

  items FormuleCatalogueItem[]
  variantLinks VariantFormule[]
}

model FormuleCatalogueItem {
  id        String @id @default(uuid())
  formuleId String
  mpId      String
  qty       Float  @default(0)

  formule FormuleCatalogue @relation(fields: [formuleId], references: [id])
  mp      MpCatalogue      @relation(fields: [mpId], references: [id])
}
