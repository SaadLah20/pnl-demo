generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// =======================
// CORE
// =======================

model Pnl {
  id        String    @id @default(uuid())
  title     String
  model     String
  client    String?
  status    String    @default("ENCOURS")
  startDate DateTime?
  city      String
  region    String
  createdAt DateTime  @default(now())

  contracts Contract[]
}

model Contract {
  id              String @id @default(uuid())
  pnlId           String
  pnl             Pnl    @relation(fields: [pnlId], references: [id])
  dureeMois       Int    @default(0)
  cab             String
  installation    String
  genieCivil      String
  transport       String
  terrain         String
  matierePremiere String
  maintenance     String
  chargeuse       String
  branchementEau  String
  consoEau        String
  branchementElec String
  consoElec       String

  postes       Int
  sundayPrice  Float
  delayPenalty Float
  chillerRent  Float

  variants Variant[]
}

model Variant {
  id          String  @id @default(uuid())
  title       String
  description String?
  status      String  @default("INITIALISEE")

  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  mp              SectionMatierePremiere?
  transport       SectionTransport?
  cab             SectionCab?
  maintenance     SectionMaintenance?
  coutM3          SectionCoutM3?
  coutMensuel     SectionCoutMensuel?
  coutOccasionnel SectionCoutOccasionnel?
  employes        SectionEmployes?
  autresCouts     SectionAutresCouts?
  formules        SectionFormules?
  majorations     SectionMajorations?
  devis           SectionDevis?

  variantMps      VariantMp[]
  variantFormules VariantFormule[]

  autreCoutItems AutreCoutItem[]
}

// =======================
// SECTIONS
// =======================

model SectionMatierePremiere {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items VariantMp[]
}

model SectionTransport {
  id        String @id @default(uuid())
  variantId String @unique
  category  String
  type      String
  prixMoyen Float?

  volumePompePct Float?
  prixAchatPompe Float?
  prixVentePompe Float?

  variant Variant @relation(fields: [variantId], references: [id])
}

model SectionCab {
  id         String  @id @default(uuid())
  variantId  String  @unique
  category   String
  etat       String
  mode       String
  capaciteM3 Float
  amortMois  Float
  variant    Variant @relation(fields: [variantId], references: [id])
}

model SectionMaintenance {
  id         String  @id @default(uuid())
  variantId  String  @unique
  category   String
  cab        Float
  elec       Float
  chargeur   Float
  generale   Float
  bassins    Float
  preventive Float
  variant    Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutM3 {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  eau       Float
  qualite   Float
  dechets   Float
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutMensuel {
  id          String  @id @default(uuid())
  variantId   String  @unique
  category    String

  // existants
  electricite Float
  gasoil      Float
  location    Float     // ⚠️ on le garde (compat). Tu peux l’utiliser comme "Location groupes"
  securite    Float

  // ✅ nouveaux champs (defaults => pas de casse)
  hebergements         Float @default(0)
  locationTerrain      Float @default(0)
  telephone            Float @default(0)
  troisG               Float @default(0)
  taxeProfessionnelle  Float @default(0)
  locationVehicule     Float @default(0)
  locationAmbulance    Float @default(0)
  locationBungalows    Float @default(0)
  epi                  Float @default(0)

  variant     Variant @relation(fields: [variantId], references: [id])
}

model SectionCoutOccasionnel {
  id           String  @id @default(uuid())
  variantId    String  @unique
  category     String

  // existants
  genieCivil   Float
  installation Float   // "Installation de la CAB"
  transport    Float

  // ✅ nouveaux champs
  demontage            Float @default(0)
  remisePointCentrale  Float @default(0)
  silots               Float @default(0)
  localAdjuvant        Float @default(0)
  bungalows            Float @default(0)

  variant      Variant @relation(fields: [variantId], references: [id])
}

model SectionEmployes {
  id               String  @id @default(uuid())
  variantId        String  @unique
  category         String

  // existants
  responsableNb    Float
  responsableCout  Float
  centralistesNb   Float
  centralistesCout Float

  // ✅ nouveaux rôles (Nb peut être 1.5 etc => Float OK)
  manoeuvreNb                     Float @default(0)
  manoeuvreCout                   Float @default(0)

  coordinateurExploitationNb      Float @default(0)
  coordinateurExploitationCout    Float @default(0)

  technicienLaboNb                Float @default(0)
  technicienLaboCout              Float @default(0)

  femmeMenageNb                   Float @default(0)
  femmeMenageCout                 Float @default(0)

  gardienNb                       Float @default(0)
  gardienCout                     Float @default(0)

  maintenancierNb                 Float @default(0)
  maintenancierCout               Float @default(0)

  panierRepasNb                   Float @default(0)
  panierRepasCout                 Float @default(0)

  variant          Variant @relation(fields: [variantId], references: [id])
}

model SectionAutresCouts {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items AutreCoutItem[]
}

model AutreCoutItem {
  id String @id @default(uuid())

  sectionId String
  section   SectionAutresCouts @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  variantId String
  variant   Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  label  String
  unite  String
  valeur Float

  @@index([variantId])
  @@index([sectionId])
}

model SectionFormules {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])

  items VariantFormule[]
}

model SectionMajorations {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  variant   Variant @relation(fields: [variantId], references: [id])
}

model SectionDevis {
  id        String  @id @default(uuid())
  variantId String  @unique
  category  String
  surcharge Float   @default(0)
  variant   Variant @relation(fields: [variantId], references: [id])
}

// =======================
// REPERTOIRES GLOBAUX
// =======================

model MpCatalogue {
  id          String  @id @default(uuid())
  categorie   String
  label       String
  unite       String
  prix        Float
  fournisseur String
  city        String
  region      String
  comment     String?

  formuleItems FormuleCatalogueItem[]
  variantItems VariantMp[]
}

model FormuleCatalogue {
  id         String  @id @default(uuid())
  label      String
  resistance String
  city       String
  region     String
  comment    String?

  items        FormuleCatalogueItem[]
  variantItems VariantFormule[]
}

model FormuleCatalogueItem {
  id        String @id @default(uuid())
  formuleId String
  mpId      String
  qty       Float

  formule FormuleCatalogue @relation(fields: [formuleId], references: [id])
  mp      MpCatalogue      @relation(fields: [mpId], references: [id])

  @@unique([formuleId, mpId])
}

model VariantMp {
  id          String  @id @default(uuid())
  variantId   String
  sectionId   String?
  mpId        String
  prix        Float
  comment     String?
  prixOverride Float?

  variant Variant                 @relation(fields: [variantId], references: [id])
  section SectionMatierePremiere? @relation(fields: [sectionId], references: [id])
  mp      MpCatalogue             @relation(fields: [mpId], references: [id])

  @@unique([variantId, mpId])
}

model VariantFormule {
  id        String  @id @default(uuid())
  variantId String
  sectionId String?
  formuleId String
  volumeM3  Float
  momd      Float

  cmpOverride Float?

  variant Variant          @relation(fields: [variantId], references: [id])
  section SectionFormules? @relation(fields: [sectionId], references: [id])
  formule FormuleCatalogue @relation(fields: [formuleId], references: [id])

  @@unique([variantId, formuleId])
}
